<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Ê∞óË±°Â∫ÅË¶≥Ê∏¨„Éá„Éº„ÇøÂèñÂæó</title>
    <!-- OK„ÅÆÈ†ÜÁï™ÔºöPlotlyÊú¨‰Ωì„ÇíÂÖà„Å´ -->
    <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
    <script src="{{ url_for('static', filename='js/plot.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <h1>Ê∞óË±°„Éá„Éº„ÇøÂèñÂæó„Éï„Ç©„Éº„É†</h1>
<div class="form-container">

    <!-- üîµ „Éá„Éº„ÇøÂèñÂæóÁî®„Éï„Ç©„Éº„É† -->
    <form method="post">
        <label>Â∫úÁúå:
            <select id="pref-select" name="prec_no">
                {% for p in prefectures %}
                    <option value="{{ p.prec_no }}"
                        {% if p.prec_no|string == prec_no|string %}selected{% endif %}>
                        {{ p.pref_name }}
                    </option>
                {% endfor %}
            </select>
        </label>

        <label>Ë¶≥Ê∏¨Âú∞ÁÇπ:
            <select id="block-select" name="block_no">
                <!-- JS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
            </select>
        </label>
        <br>

        <label>ÈñãÂßãÊó•ÊôÇ: <input type="datetime-local" name="start_time" value="{{ start_time }}"></label><br>
        <label>ÁµÇ‰∫ÜÊó•ÊôÇ: <input type="datetime-local" name="end_time" value="{{ end_time }}"></label><br>

        <button type="submit" name="action" value="fetch">„Éá„Éº„ÇøÂèñÂæó</button>

        {% if columns and columns|length > 0 %}
            <a href="{{ url_for('main.download') }}">
                <button type="button">CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
            </a>
        {% endif %}
    </form>

    <!-- üîµ „Ç∞„É©„ÉïË°®Á§∫Áî®„Éï„Ç©„Éº„É†Ôºàcolumns „Åå„ÅÇ„Çã„Å®„Åç„ÅÆ„ÅøÔºâ -->
    {% if columns %}
    <form method="post">
        <!-- üîí Èö†„Åó„Éï„Ç£„Éº„É´„Éâ„ÅßÁä∂ÊÖã„ÇíÂºï„ÅçÁ∂ô„Åê -->
        <input type="hidden" name="block_no" value="{{ block_no }}">
        <input type="hidden" name="prec_no" value="{{ prec_no }}">
        <input type="hidden" name="start_time" value="{{ start_time }}">
        <input type="hidden" name="end_time" value="{{ end_time }}">

        <fieldset>
            <legend>Ë°®Á§∫Ë¶ÅÁ¥†ÔºàÊúÄÂ§ß3„Å§Ôºâ</legend>
            <table>
                <tbody>
                {% for i in range(0, columns|length, 2) %}
                    <tr>
                        <td>
                            {% set col1 = columns[i] %}
                            <label>
                                <input type="checkbox" name="elements" value="{{ col1 }}"
                                    {% if selected and col1 in selected %}checked{% endif %}>
                                {{ col1 }}
                            </label>
                        </td>
                        <td>
                            {% if i + 1 < columns|length %}
                                {% set col2 = columns[i + 1] %}
                                <label style="margin-left: 20px;">
                                    <input type="checkbox" name="elements" value="{{ col2 }}"
                                        {% if selected and col2 in selected %}checked{% endif %}>
                                    {{ col2 }}
                                </label>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </fieldset>

        <button type="submit" name="action" value="plot">„Ç∞„É©„ÉïË°®Á§∫</button>
    </form>
    {% endif %}

</div>

<!-- üîµ „Éó„É≠„ÉÉ„Éà„Éá„Éº„Çø„Åå„ÅÇ„Çã„Å®„Åç„Å´ÊèèÁîª„Ç®„É™„Ç¢ -->
{% if plot_data %}
    <div id="plot"></div>
    <script id="plot-data" type="application/json">
        {{ plot_data | tojson | safe }}
    </script>
{% endif %}

<!-- üîµ Ë¶≥Ê∏¨Âú∞ÁÇπ„Éá„Éº„Çø„Çí JS „Å´Ê∏°„Åô -->
<script id="stations-data" type="application/json">
    {{ stations | tojson | safe }}
</script>

<!-- üîµ JavaScript„ÅßË¶≥Ê∏¨Âú∞ÁÇπ„ÇíÂãïÁöÑ„Å´Âàá„ÇäÊõø„Åà -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const stations = JSON.parse(document.getElementById("stations-data").textContent);
        const prefSelect = document.getElementById("pref-select");
        const blockSelect = document.getElementById("block-select");

        const selectedPrecNo = "{{ prec_no }}";
        const selectedBlockNo = "{{ block_no }}";
        console.log("selectedPrecNo:", selectedPrecNo);
        console.log("selectedBlockNo:", selectedBlockNo);

        function filterStations(precNo, selectedBlock = null) {
            blockSelect.innerHTML = "";

            const filtered = stations.filter(s => String(s.prec_no) === String(precNo));
            filtered.forEach(s => {
                const opt = document.createElement("option");
                opt.value = s.block_no;
                opt.textContent = s.name;
                if (String(s.block_no) === String(selectedBlock)) {
                    opt.selected = true;
                }
                blockSelect.appendChild(opt);
            });
        }

        filterStations(selectedPrecNo, selectedBlockNo);

        prefSelect.addEventListener("change", () => {
            filterStations(prefSelect.value);
        });
    });
</script>
</body>
</html>